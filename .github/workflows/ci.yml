name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  # Format check - fast, runs first
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - name: Check format
        run: cargo fmt --all -- --check

  # Lint - can run in parallel with format
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci-lint"
          save-if: true
      - name: Lint
        run: cargo clippy --all --all-targets -- -D warnings

  # Unit tests - parallel with lint
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci-test"
          save-if: true
      - name: Run unit tests
        run: cargo test unit_tests -- --nocapture

  # Integration tests - parallel, needs Foundry
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci-test"
          save-if: true
      - name: Cache Foundry
        uses: actions/cache@v4
        with:
          path: ~/.foundry
          key: foundry-${{ runner.os }}-stable
          restore-keys: |
            foundry-${{ runner.os }}-
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Compile mock contracts
        working-directory: tests/contracts
        run: forge build

      - name: Run integration tests
        run: |
          ./scripts/anvil-cleanup.sh
          cargo test integration_tests -- --nocapture
          ./scripts/anvil-cleanup.sh

  # Wallet/Redis tests - parallel, needs Redis service
  wallet-tests:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci-test"
          save-if: true
      - name: Run wallet tests (Redis-dependent)
        env:
          REDIS_URL: redis://127.0.0.1:6379
        run: |
          # Run wallet module tests from library (parallel - each test uses unique Redis prefix)
          cargo test --lib wallet -- --ignored --nocapture
          # Run unit tests that require WalletManager with Redis (parallel - each test uses unique Redis prefix)
          cargo test unit_tests -- --ignored --nocapture

  # Full integration tests - needs both Anvil and Redis
  full-integration-tests:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci-full-integration"
          save-if: true
      - name: Cache Foundry
        uses: actions/cache@v4
        with:
          path: ~/.foundry
          key: foundry-${{ runner.os }}-stable
          restore-keys: |
            foundry-${{ runner.os }}-
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Compile mock contracts
        working-directory: tests/contracts
        run: forge build

      - name: Run full integration tests (Anvil + Redis)
        env:
          REDIS_URL: redis://127.0.0.1:6379
        run: |
          # Flush Redis to ensure clean state (exec into the Redis service container)
          docker exec $(docker ps -q -f ancestor=redis:alpine) redis-cli FLUSHALL
          # Cleanup any existing Anvil instances
          ./scripts/anvil-cleanup.sh
          # Run nonce conflict tests (need Redis, work with mock contracts)
          # Parallel execution enabled - each test uses unique Redis key prefix
          cargo test nonce_conflict_tests -- --ignored --nocapture
          # Run beacon integration tests (need Redis + Anvil + mock contracts)
          cargo test beacon_core_integration_tests -- --ignored --nocapture
          cargo test register_beacon_integration_tests -- --ignored --nocapture
          # Cleanup
          ./scripts/anvil-cleanup.sh

  # Docker build - depends on all test jobs passing
  docker:
    runs-on: ubuntu-latest
    needs: [format, lint, unit-tests, integration-tests, wallet-tests, full-integration-tests]
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-buildx-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            docker-buildx-

      - name: Build Docker image with aggressive caching
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: the-beaconator:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          platforms: linux/amd64

      - name: Test Docker image
        run: |
          # Use host network so container can reach Redis service
          docker run --rm -d --name test-beaconator --network host \
            -e RPC_URL=https://mainnet.base.org \
            -e PRIVATE_KEY=0000000000000000000000000000000000000000000000000000000000000001 \
            -e SENTRY_DSN=https://test@test.ingest.sentry.io/test \
            -e ENV=localnet \
            -e BEACONATOR_ACCESS_TOKEN=test_token_123 \
            -e BEACON_FACTORY_ADDRESS=0x1234567890123456789012345678901234567890 \
            -e PERPCITY_REGISTRY_ADDRESS=0x3456789012345678901234567890123456789012 \
            -e PERP_MANAGER_ADDRESS=0x5678901234567890123456789012345678901234 \
            -e USDC_ADDRESS=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 \
            -e FEES_MODULE_ADDRESS=0x4567890123456789012345678901234567890123 \
            -e MARGIN_RATIOS_MODULE_ADDRESS=0x5678901234567890123456789012345678901234 \
            -e LOCKUP_PERIOD_MODULE_ADDRESS=0x6789012345678901234567890123456789012345 \
            -e SQRT_PRICE_IMPACT_LIMIT_MODULE_ADDRESS=0x7890123456789012345678901234567890123456 \
            -e REDIS_URL=redis://127.0.0.1:6379 \
            -e WALLET_PRIVATE_KEYS=0000000000000000000000000000000000000000000000000000000000000002,0000000000000000000000000000000000000000000000000000000000000003 \
            the-beaconator:latest
          sleep 15
          curl -f http://localhost:8000/ || (docker logs test-beaconator && exit 1)
          docker stop test-beaconator

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
