name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy, rustfmt
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      - name: Build
        run: cargo build --all --release
      - name: Lint
        run: cargo clippy --all -- -D warnings
      - name: Format
        run: cargo fmt --all -- --check
      - name: Make cleanup script executable
        run: chmod +x scripts/anvil-cleanup.sh
      - name: Clean up Anvil processes
        run: ./scripts/anvil-cleanup.sh
      - name: Run unit tests (parallel)
        run: |
          echo "Running unit tests in parallel..."
          cargo test models::models_test -- --nocapture
          echo "Unit tests completed successfully ✅"
      - name: Clean up before integration tests
        run: ./scripts/anvil-cleanup.sh
      - name: Run integration tests (single-threaded)
        run: |
          echo "Running integration tests with single thread to avoid race conditions..."
          cargo test routes -- --nocapture --test-threads=1
          echo "Integration tests completed successfully ✅"
      - name: Verify all tests were run
        run: |
          echo "Verifying test coverage..."
          TOTAL_TESTS=$(cargo test -- --list | grep -c ": test$" || echo "0")
          UNIT_TESTS=$(cargo test models::models_test -- --list | grep -c ": test$" || echo "0")
          INTEGRATION_TESTS=$(cargo test routes -- --list | grep -c ": test$" || echo "0")
          echo "Total tests found: $TOTAL_TESTS"
          echo "Unit tests: $UNIT_TESTS"
          echo "Integration tests: $INTEGRATION_TESTS"
          COVERED=$((UNIT_TESTS + INTEGRATION_TESTS))
          echo "Tests covered by CI: $COVERED"
          if [ "$TOTAL_TESTS" -ne "$COVERED" ]; then
            echo "⚠️  Warning: Some tests may not be covered by CI patterns"
            echo "Missing tests: $((TOTAL_TESTS - COVERED))"
          else
            echo "✅ All tests are covered by CI"
          fi

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        run: docker build -t the-beaconator .
      - name: Test Docker image
        run: |
          docker run --rm -d --name test-beaconator -p 8000:8000 \
            -e RPC_URL=https://mainnet.base.org \
            -e PRIVATE_KEY=0000000000000000000000000000000000000000000000000000000000000001 \
            -e SENTRY_DSN=https://test@test.ingest.sentry.io/test \
            -e ENV=localnet \
            -e BEACONATOR_ACCESS_TOKEN=test_token_123 \
            -e BEACON_FACTORY_ADDRESS=0x1234567890123456789012345678901234567890 \
            -e PERPCITY_REGISTRY_ADDRESS=0x3456789012345678901234567890123456789012 \
            -e PERP_HOOK_ADDRESS=0x5678901234567890123456789012345678901234 \
            -e USDC_ADDRESS=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 \
            the-beaconator
          sleep 10
          curl -f http://localhost:8000/ || exit 1
          docker stop test-beaconator 